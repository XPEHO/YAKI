name: Run karate testing on push
on: push
jobs:
  karate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
      - uses: actions/setup-java@v3
        with:
          distribution: "temurin"
          java-version: "17"
      - name: Run karate tests
        run: |
          cd yaki_docker
          echo "Creating create_user.sql file"
          echo ${{ secrets.KARATE_DB_USER_CREATION }} | base64 -d > create_user.txt
          echo "${cat create_user.txt}"
          echo "Creating create_table.sql file"
          echo ${{ secrets.KARATE_DB_TABLE_CREATION }} | base64 -d > create_table.sql
          echo "Creating create_data.sql file"
          echo ${{ secrets.KARATE_DB_DATA_CREATION }} | base64 -d > create_data.sql
          echo "Creating .env file"
          echo ${{ secrets.ENV_FILE }} | base64 -d > .env
          cd ../yaki_backend
          echo "Creating .env file"
          echo ${{ secrets.ENV_FILE }} | base64 -d > .env
          echo "Install dependencies"
          npm i
          echo "Generate swagger.json file"
          npm run swagger
          echo "build java"
          cd ../yaki_admin_backend
          echo ${{ secrets.APPLICATION_PROPERTIES }} | base64 -d > src/main/resources/application.properties
          echo ${{ secrets.APPLICATION_TEST_PROPERTIES }} | base64 -d > src/test/resources/application-test.properties
          gradle clean build
          echo "Starting docker containers"
          cd ../yaki_docker
          docker compose up --build --quiet-pull -d
          echo "inset .sql files into the database"
          docker exec -i yaki_docker-bdd-1 psql -U postgres -d postgres -a -f /yaki_docker/create_table.sql
          echo "Sleep 10s to wait backend admin initialization"
          sleep 10s
          echo "sleep finished"
          cd ../yaki_karate
          echo ${{ secrets.KARATE_CONFIG }} | base64 -d > .env
          echo "Running karate tests"
          mvn test --quiet
          cd ../yaki_docker
          echo "Stopping docker containers"
          docker compose down
